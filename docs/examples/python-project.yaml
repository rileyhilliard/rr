# Example: Python project with pytest
#
# This is a PROJECT config (.rr.yaml) for a typical Python project that runs
# tests on a remote machine with more CPU/RAM than your laptop.
#
# NOTE: Host definitions belong in your GLOBAL config (~/.rr/config.yaml).
# See global-config.yaml for an example global config.

version: 1

# Reference the host from your global config
# If omitted, all global hosts are available
host: build-box

sync:
  exclude:
    - .git/
    - .venv/
    - __pycache__/
    - "*.pyc"
    - .mypy_cache/
    - .pytest_cache/
    - .ruff_cache/
    - .coverage
    - htmlcov/
    - dist/
    - "*.egg-info/"
  preserve:
    # Keep the remote venv - don't delete it on sync
    - .venv/

tasks:
  test:
    description: Run pytest with coverage
    run: .venv/bin/pytest tests/ -v --tb=short

  test-fast:
    description: Run tests without coverage
    run: .venv/bin/pytest tests/ -v --tb=short -x

  lint:
    description: Run ruff linter
    run: .venv/bin/ruff check .

  typecheck:
    description: Run mypy type checker
    run: .venv/bin/mypy src/

  install:
    description: Install dependencies in remote venv
    steps:
      - name: Create venv
        run: python3 -m venv .venv
      - name: Install deps
        run: .venv/bin/pip install -e ".[dev]"

  # Parallel tasks - run multiple checks simultaneously
  verify:
    description: Run all checks in parallel
    parallel:
      - test
      - lint
      - typecheck
    fail_fast: false

  # Flake detection - run tests multiple times to find intermittent failures
  flake-check:
    description: Run tests 5x to detect flaky tests
    parallel:
      - test
      - test
      - test
      - test
      - test
    fail_fast: false

output:
  format: pytest
  timing: true
