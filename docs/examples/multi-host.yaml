# Example: Multi-host setup with load balancing
#
# This config shows how to set up multiple hosts for load balancing and
# targeting specific machines. Useful for small teams sharing build servers.
#
# With multiple hosts configured, rr automatically distributes work:
# - Tries hosts in alphabetical order with non-blocking lock checks
# - If a host is locked, immediately tries the next available host
# - If all hosts are locked, waits and round-robins until one is free

version: 1

hosts:
  mac-mini:
    ssh:
      - mac-mini.local
      - mac-mini-tailscale
    dir: ${HOME}/builds/${PROJECT}
    tags:
      - fast
      - macos
      - gpu

  linux-server:
    ssh:
      - linux-server.internal
      - linux-tailscale
    dir: /home/builds/${PROJECT}
    tags:
      - linux
      - docker

  raspberry-pi:
    ssh:
      - pi.local
    dir: ${HOME}/projects/${PROJECT}
    tags:
      - arm
      - linux

# Default to the fastest machine
default: mac-mini

# Fall back to local if all remotes are down
local_fallback: true

# Longer timeout for flaky connections
probe_timeout: 5s

sync:
  exclude:
    - .git/
    - node_modules/
    - .venv/
    - __pycache__/
    - build/
    - dist/
  preserve:
    - node_modules/
    - .venv/

lock:
  enabled: true
  timeout: 10m       # How long to wait when acquiring lock on a single host
  wait_timeout: 2m   # How long to round-robin when all hosts are locked
  stale: 30m         # Consider locks older than this as stale

tasks:
  test:
    description: Run tests on any host
    run: make test

  build-linux:
    description: Build Linux binary
    hosts:
      - linux-server
    run: make build-linux

  build-arm:
    description: Build ARM binary
    hosts:
      - raspberry-pi
    run: make build-arm

  docker-build:
    description: Build Docker image
    hosts:
      - linux-server  # Only the Linux box has Docker
    run: docker build -t myapp .

  gpu-train:
    description: Run ML training
    hosts:
      - mac-mini  # Only the Mac Mini has a GPU
    run: python train.py

# Usage:
#   rr test                     # Runs on first available host (load balanced)
#   rr test --host linux-server # Runs on specific host (no load balancing)
#   rr test --tag linux         # Runs on any host tagged 'linux'
#   rr build-linux              # Only runs on linux-server (task-specific host)
#
# Load balancing behavior:
#   - With multiple hosts and no --host flag, rr tries each host until one is free
#   - If local_fallback is true and all hosts are locked, runs locally immediately
#   - Otherwise waits up to wait_timeout, checking hosts in round-robin fashion
